---
machine:
  environment:
    CACHE_DIR: ~/deps
checkout:
  post:
    - |
      rm -rf ~/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME;
      mkdir -p ~/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME;
      cp -R ~/$CIRCLE_PROJECT_REPONAME ~/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/;
      rm -rf ~/$CIRCLE_PROJECT_REPONAME;
      ln -s ~/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME ~/$CIRCLE_PROJECT_REPONAME;
dependencies:
  cache_directories:
    - $CACHE_DIR
  override:
    - go version
    - >
      go get
      github.com/jstemmer/go-junit-report
      github.com/alecthomas/gometalinter
      github.com/tools/godep
      github.com/mattn/goveralls
    - gometalinter --install
    - >
      mkdir -p
      $CIRCLE_TEST_REPORTS/go
    - make deps
test:
  override:
    - >
      go test -v -race
      -cover -coverprofile=coverage.out
      | tee output;
      test ${PIPESTATUS[0]} -eq 0
    - make test -j4
  post:
    - gometalinter --deadline 30s || true
    - |
      cat output | go-junit-report > $CIRCLE_TEST_REPORTS/go/junit.xml;
      go tool cover -html=coverage.out -o $CIRCLE_ARTIFACTS/coverage.html;
      goveralls -coverprofile=coverage.out -service=circle-ci -repotoken=$COVERALLS_TOKEN;
deployment:
  v5:
    branch: v5
    commands:
      - DIST_DIR=$CIRCLE_ARTIFACTS CHANNEL=dev make release -j4
