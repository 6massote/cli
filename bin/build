#!/usr/bin/env node

'use strict';

let childProcess = require('child_process');
let https        = require('https');
let fs           = require('mz/fs');
let config       = require('../config.json');
let tar          = require('tar');
let path         = require('path');
let fstream      = require('fstream');
let zlib         = require('zlib');
let lzma         = require('lzma-native');

const version = childProcess.execSync(__dirname+'/version', {encoding: 'utf8'}).trim();
// TODO: look up channel
const channel = 'dev';
const revision = childProcess.execSync('git log -n 1 --pretty=format:"%H"');
const os = 'darwin';
const arch = 'amd64';
const dir = `./dist/heroku-${os}-${arch}`;
const binPath = `${dir}/heroku-cli`;
const nodePath = `${dir}/node`;
const ldflags = `-X=main.Version=${version} -X=main.Channel=${channel} -X=main.GitSHA=${revision}`;
const npmPath = './dist/npm.tar.gz';

let mkdirp = dir => new Promise((ok, fail) => require('mkdirp')(dir, err => err ? fail(err) : ok()));
let rimraf = dir => new Promise((ok, fail) => require('rimraf')(dir, err => err ? fail(err) : ok()));
let ncp = (s, d) => new Promise((ok, fail) => require('ncp')(s, d, err => err ? fail(err) : ok()));

let httpGet = url => {
  console.log(`HTTP GET ${url}`);
  return new Promise((ok, fail) => {
    https.get(url, res => {
      if (res.statusCode >= 300 && res.statusCode <= 399) return ok(httpGet(res.headers.location));
      if (res.statusCode <= 199 || res.statusCode >= 400) return fail(new Error(`${res.statusCode}:${url}`));
      ok(res);
    });
  });
};

let download = (url, file) => {
  return mkdirp(path.dirname(file))
  .then(() => httpGet(url))
  .then(res => new Promise((ok, fail) => {
    console.log(`saving to ${file}`);
    res.pipe(fs.createWriteStream(file)
             .on('error', fail)
             .on('close', ok));
  }));
};

let extractTarGZ = (from, to) => {
  console.log(`extracting to ${to}`);
  return new Promise((ok, fail) => {
    let extractor = tar.Extract({path: to}).on('error', fail).on('end', ok);
    from = typeof from === 'string' ? fs.createReadStream(from) : from;
    from.pipe(zlib.createGunzip()).pipe(extractor);
  });
};

let tarDirectory = (dir, file) => {
  console.log(`tarring ${dir} to ${file}`);
  return new Promise((ok, fail) => {
    let packer = tar.Pack().on('error', fail).on('end', ok);
    fstream.Reader({path: dir, type: 'Directory'})
    .on('error', fail)
    .pipe(packer)
    .pipe(lzma.createCompressor())
    .pipe(fs.createWriteStream(file).on('error', fail).on('end', ok));
  });
};

let spawn = (cmd, args, opts) => {
  return new Promise((ok, fail) => {
    console.log(`> ${cmd} ${args.join(' ')}`);
    opts = Object.assign({stdio: 'inherit'}, opts);
    opts.env = Object.assign({}, process.env, opts.env);
    childProcess.spawn(cmd, args, opts)
    .on('error', fail)
    .on('close', code => code === 0 ? ok() : fail(`${cmd} ${args.join(' ')} exit code: ${code}`));
  });
};

let downloadNpm = () => {
  return fs.exists(npmPath)
  .then(exists => exists ? null : download(`https://github.com/npm/npm/archive/v${config.npmVersion}.tar.gz`, npmPath));
};

let downloadNode = () => {
  let base = `node-v${config.nodeVersion}-darwin-x64`;
  let archive = `${base}.tar.gz`;
  return fs.exists(`./dist/${base}/bin/node`)
  .then(exists => {
    if (exists) {
      return ncp(`./dist/${base}/bin/node`, nodePath);
    } else {
      return httpGet(`https://nodejs.org/download/release/v${config.nodeVersion}/${archive}`)
      .then(res => extractTarGZ(res, './dist'))
      .then(() => fs.chmod(`./dist/${base}/bin/node`, 0o755))
      .then(() => ncp(`./dist/${base}/bin/node`, nodePath));
    }
  });
};

let installPlugins = () => {
  let plugins = Object.keys(config.pjson.dependencies).map(d => `${d}@${config.pjson.dependencies[d]}`);
  return mkdirp(`./dist/core/node_modules`)
  .then(() => fs.writeFile(`./dist/core/package.json`, JSON.stringify(config.pjson), 'utf8'))
  .then(() => spawn('./dist/heroku', ['plugins:install'].concat(plugins)))
  .then(() => spawn('npm', ['prune']))
  .then(() => spawn('npm', ['dedupe']));
};

process.on('unhandledRejection', err => console.error(err));
process.on('uncaughtException', err => console.error(err));

spawn('go', ['build', '-o', './dist/heroku'])
.then(() => spawn('go', ['build', '-o', binPath, '-ldflags', ldflags], {GOOS: os, GOARCH: arch}))
.then(() => downloadNode())
.then(() => downloadNpm())
.then(() => extractTarGZ(npmPath, dir))
.then(() => installPlugins())
.then(() => mkdirp(`${dir}/core`))
.then(() => ncp(`./dist/core/node_modules`, `${dir}/core/node_modules`))
.then(() => tarDirectory(dir, `${dir}.tar.xz`))
.then(() => rimraf(dir))
.then(() => rimraf('./dist/node_modules'))
.then(() => console.log('done'))
.catch(err => {console.error(err.stack || err); process.exit(1);});
